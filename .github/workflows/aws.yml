name: CI/CD

on:
  push:
    branches: [dev2]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2 
      - name: Deploy in EC2
        env:
            PRIVATE_KEY: ${{ secrets.AWS_PRIVATE_KEY  }}
            HOSTNAME : ${{ secrets.HOSTNAME  }}
            USERNAME : ${{ secrets.USERNAME  }}
            CONNECTION_STRING : ${{ secrets.DB_CONNECTION_STRING }}
            SESSION_SECRET : ${{ secrets.SESSION_SECRET }}
            PORT : ${{ secrets.PORT }}
      
        run: |
            echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
            printf "export CONNECTION_STRING="$CONNECTION_STRING"\nexport SESSION_SECRET=$SESSION_SECRET\nexport PORT=$PORT" > populate_env
            scp -o StrictHostKeyChecking=no -i private_key populate_env ${USERNAME}@${HOSTNAME}:~/
            ssh -o StrictHostKeyChecking=no -i private_key ${USERNAME}@${HOSTNAME} '
          
            source ./populate_env &&
            rm -rf Chat-App &&
            git clone git@github.com:jhassan12/Chat-App.git &&
            cd Chat-App &&
            npm install &&
            node app.js
            '
          
          
